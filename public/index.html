<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tost UI - S3 Media Viewer</title>
    <link rel="icon" href="https://ui.tost.ai/favicon.ico">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
      }
    }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        .main-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 280px;
            background: #1a1a1a;
            border-right: 1px solid rgba(255, 255, 255, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            flex-shrink: 0;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .filter-buttons {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .filter-btn {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            background: transparent;
            color: #ffffff;
            transition: all 0.2s;
        }

        .filter-btn.active {
            background: #333333;
            color: #ffffff;
        }

        .sidebar-header input {
            width: 100%;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 8px 12px;
            border-radius: 4px;
            color: #ffffff;
            font-size: 13px;
        }

        .sidebar-header input:focus {
            outline: none;
            border-color: #ffffff;
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .file-item {
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 3px;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .file-item.active {
            background: rgba(255, 255, 255, 0.2);
        }

        .file-icon {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.1);
        }

        .file-icon.image { background: rgba(255, 255, 255, 0.15); }
        .file-icon.video { background: rgba(255, 255, 255, 0.15); }
        .file-icon.audio { background: rgba(255, 255, 255, 0.15); }
        .file-icon.document { background: rgba(255, 255, 255, 0.15); }
        .file-icon.model3d { background: rgba(255, 255, 255, 0.15); }
        .file-icon.other { background: rgba(255, 255, 255, 0.15); }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            display: flex;
            font-size: 12px;
            font-weight: 500;
        }

        .name-part {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
        }

        .ext-part {
            flex-shrink: 0;
            color: #888;
        }

        .file-meta {
            font-size: 9px;
            color: #888;
            margin-top: 1px;
        }

        .btn {
            padding: 6px 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            background: transparent;
            color: #ffffff;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #ffffff;
            color: #000000;
        }

        .viewer-area {
            flex: 1;
            background-color: #1a1a1a;
            background-image:
                linear-gradient(45deg, #121212 25%, transparent 25%),
                linear-gradient(-45deg, #121212 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #121212 75%),
                linear-gradient(-45deg, transparent 75%, #121212 75%);
            background-size: 40px 40px;
            background-position: 0 0, 0 20px, 20px -20px, -20px 0px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .viewer-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Image Viewer */
        .image-container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        .image-container img {
            position: absolute;
            top: 50%;
            left: 50%;
            cursor: grab;
            user-select: none;
            transform-origin: center;
        }

        .image-container img:active {
            cursor: grabbing;
        }

        /* Video Viewer */
        .video-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
        }

        .video-wrapper video {
            flex: 1;
            min-height: 0;
            width: 100%;
            object-fit: contain;
        }

        .video-controls {
            flex-shrink: 0;
            background: #1a1a1a;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .play-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #ffffff;
            border: none;
            color: #000000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .play-btn:hover {
            background: #dddddd;
        }

        .progress-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .progress-bar {
            width: 100%;
            height: 5px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            cursor: pointer;
        }

        .progress-fill {
            height: 100%;
            background: #ffffff;
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s;
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #888;
        }

        .volume-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .volume-slider {
            width: 60px;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            cursor: pointer;
        }

        .volume-level {
            height: 100%;
            background: #ffffff;
            border-radius: 2px;
            width: 100%;
        }

        /* Audio Viewer */
        .audio-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            gap: 20px;
        }

        .audio-artwork {
            width: 150px;
            height: 150px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
        }

        .audio-details {
            text-align: center;
        }

        .audio-title {
            font-size: 1.1rem;
            margin-bottom: 3px;
        }

        .audio-artist {
            color: #888;
            font-size: 12px;
        }

        .audio-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .audio-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .audio-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .audio-btn.play {
            width: 60px;
            height: 60px;
            background: #ffffff;
            color: #000000;
            font-size: 18px;
        }

        .audio-btn.play:hover {
            background: #dddddd;
        }

        .audio-progress-container {
            width: 70%;
            max-width: 400px;
        }

        .audio-time {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #888;
            margin-top: 4px;
        }

        .model-viewer-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        model-viewer {
            width: 100%;
            height: 100%;
        }

        .model-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .image-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            color: #888;
            font-size: 12px;
        }

        .model-loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .ply-viewer-container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .ply-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .ply-viewer-controls {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 12px;
            border-radius: 20px;
        }

        .ply-btn {
            padding: 6px 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            background: transparent;
            color: #ffffff;
        }

        .ply-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Empty/Loading States */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #888;
            gap: 12px;
        }

        .empty-state svg {
            width: 60px;
            height: 60px;
            opacity: 0.4;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border-width: 3px;
            border-style: solid;
            border-color: rgba(255, 255, 255, 0.2);
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #000000;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 25px;
            width: 90%;
            max-width: 420px;
        }

        .modal h2 {
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 1.2rem;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #888;
        }

        .form-group input {
            width: 100%;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 10px 12px;
            border-radius: 4px;
            color: #ffffff;
            font-size: 13px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #ffffff;
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="filter-buttons">
                    <button class="filter-btn active" id="filterAll" onclick="setFilter('all')">All</button>
                    <button class="filter-btn" id="filterImages" onclick="setFilter('image')">Images</button>
                    <button class="filter-btn" id="filterVideos" onclick="setFilter('video')">Videos</button>
                    <button class="filter-btn" id="filterAudio" onclick="setFilter('audio')">Audio</button>
                    <button class="filter-btn" id="filter3d" onclick="setFilter('model3d')">3D</button>
                </div>
                <input type="text" id="bucketInput" placeholder="Bucket name..." oninput="handleBucketChange()" style="margin-bottom: 8px;">
                <input type="text" id="searchInput" placeholder="Search files..." oninput="filterFiles()">
            </div>
            <div class="file-list" id="fileList">
                <div class="empty-state">
                    <div class="loading-spinner"></div>
                    <p>Loading...</p>
                </div>
            </div>
        </div>

        <div class="viewer-area">
            <div class="viewer-content" id="viewerContent">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <p>Select a file to view</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <h2>S3 Configuration</h2>
            <div class="form-group">
                <label>Bucket Name *</label>
                <input type="text" id="s3Bucket" placeholder="my-bucket">
            </div>
            <div class="form-group">
                <label>Endpoint (leave empty for AWS)</label>
                <input type="text" id="s3Endpoint" placeholder="http://localhost:9000">
            </div>
            <div class="form-group">
                <label>Region</label>
                <input type="text" id="s3Region" placeholder="us-east-1" value="us-east-1">
            </div>
            <div class="form-group">
                <label>Access Key ID *</label>
                <input type="text" id="awsAccessKey" placeholder="AKIAIOSFODNN7EXAMPLE">
            </div>
            <div class="form-group">
                <label>Secret Access Key *</label>
                <input type="password" id="awsSecretKey" placeholder="wJalrXUtnFEMI/K7MDENG/bPxRfiCY...">
            </div>
            <div class="form-group">
                <label>Prefix</label>
                <input type="text" id="s3Prefix" placeholder="media/">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="saveSettings()">Save & Reload</button>
            </div>
        </div>
    </div>

    <script>
        let files = [];
        let currentFile = null;
        let imageTransform = { scale: 1, x: 0, y: 0 };
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let mediaEl = null;
        let currentFilter = 'all';

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const dx = e.clientX - dragStart.x;
                const dy = e.clientY - dragStart.y;
                const sensitivity = 0.8 / imageTransform.scale;
                imageTransform.x += dx * sensitivity;
                imageTransform.y += dy * sensitivity;
                dragStart = { x: e.clientX, y: e.clientY };
                updateImageTransform();
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            refreshFiles();
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            // Don't navigate when typing in input fields
            if (e.target.tagName === 'INPUT') return;

            const filterTypes = ['all', 'image', 'video', 'audio', 'model3d'];
            const currentFilterIndex = filterTypes.indexOf(currentFilter);

            if (e.key === 'ArrowUp') {
                e.preventDefault();
                const nextIndex = (currentFilterIndex + 1) % filterTypes.length;
                setFilter(filterTypes[nextIndex]);
                return;
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                const prevIndex = (currentFilterIndex - 1 + filterTypes.length) % filterTypes.length;
                setFilter(filterTypes[prevIndex]);
                return;
            }

            if (!currentFile || files.length === 0) return;

            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = files.filter(f => {
                const matchesSearch = f.name.toLowerCase().includes(search);
                const matchesType = currentFilter === 'all' || f.type === currentFilter;
                return matchesSearch && matchesType;
            });

            const currentIndex = filtered.findIndex(f => f.key === currentFile.key);
            if (currentIndex === -1) return;

            if (e.key === 'ArrowRight') {
                e.preventDefault();
                const nextIndex = currentIndex + 1;
                if (nextIndex < filtered.length) {
                    selectFile(encodeURIComponent(filtered[nextIndex].key));
                    scrollToFile(filtered[nextIndex].key);
                }
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                const prevIndex = currentIndex - 1;
                if (prevIndex >= 0) {
                    selectFile(encodeURIComponent(filtered[prevIndex].key));
                    scrollToFile(filtered[prevIndex].key);
                }
            }

            // Image zoom controls
            if (currentFile && currentFile.type === 'image') {
                if (e.key === '+') {
                    e.preventDefault();
                    imageTransform.scale = Math.max(0.1, Math.min(10, imageTransform.scale * 1.1));
                    updateImageTransform();
                } else if (e.key === '-') {
                    e.preventDefault();
                    imageTransform.scale = Math.max(0.1, Math.min(10, imageTransform.scale * 0.9));
                    updateImageTransform();
                }
            }
        });

        function scrollToFile(key) {
            const fileEl = document.querySelector(`.file-item[onclick*="${encodeURIComponent(key)}"]`);
            if (fileEl) {
                fileEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function setFilter(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            if (type === 'all') {
                document.getElementById('filterAll').classList.add('active');
            } else if (type === 'image') {
                document.getElementById('filterImages').classList.add('active');
            } else if (type === 'video') {
                document.getElementById('filterVideos').classList.add('active');
            } else if (type === 'audio') {
                document.getElementById('filterAudio').classList.add('active');
            } else if (type === 'model3d') {
                document.getElementById('filter3d').classList.add('active');
            }
            renderFileList(document.getElementById('searchInput').value);
        }

        function loadConfig() {
            const saved = localStorage.getItem('s3ViewerConfig');
            if (saved) {
                const config = JSON.parse(saved);
                document.getElementById('bucketInput').value = config.bucket || '';
                document.getElementById('s3Bucket').value = config.bucket || '';
                document.getElementById('s3Endpoint').value = config.endpoint || '';
                document.getElementById('s3Region').value = config.region || 'us-east-1';
                document.getElementById('awsAccessKey').value = config.accessKey || '';
                document.getElementById('awsSecretKey').value = config.secretKey || '';
                document.getElementById('s3Prefix').value = config.prefix || '';
            }
        }

        function handleBucketChange() {
            const bucket = document.getElementById('bucketInput').value.trim();
            if (bucket) {
                const saved = localStorage.getItem('s3ViewerConfig') || '{}';
                const config = JSON.parse(saved);
                config.bucket = bucket;
                localStorage.setItem('s3ViewerConfig', JSON.stringify(config));
                setBucketOnServer(bucket);
                refreshFiles();
            }
        }

        async function setBucketOnServer(bucket) {
            try {
                await fetch('/api/set-bucket', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bucket }),
                });
            } catch (e) {
                console.error('Failed to set bucket:', e);
            }
        }

        function saveSettings() {
            const config = {
                bucket: document.getElementById('s3Bucket').value,
                endpoint: document.getElementById('s3Endpoint').value,
                region: document.getElementById('s3Region').value,
                accessKey: document.getElementById('awsAccessKey').value,
                secretKey: document.getElementById('awsSecretKey').value,
                prefix: document.getElementById('s3Prefix').value,
            };

            if (!config.bucket || !config.accessKey || !config.secretKey) {
                alert('Please fill in all required fields');
                return;
            }

            localStorage.setItem('s3ViewerConfig', JSON.stringify(config));
            document.getElementById('bucketInput').value = config.bucket;
            saveEnvFile(config);
            closeSettings();
            refreshFiles();
        }

        async function saveEnvFile(config) {
            try {
                await fetch('/api/save-env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config),
                });
            } catch (e) {
                console.error('Failed to save .env:', e);
            }
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        async function refreshFiles() {
            const bucket = document.getElementById('bucketInput').value.trim();
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '<div class="empty-state"><div class="loading-spinner"></div><p>Loading...</p></div>';

            try {
                const url = bucket ? `/api/files?bucket=${encodeURIComponent(bucket)}` : '/api/files';
                const res = await fetch(url);
                const data = await res.json();

                if (data.error) {
                    fileList.innerHTML = `<div class="empty-state"><p>${data.error}</p></div>`;
                    return;
                }

                files = data.files || [];
                renderFileList();
            } catch (error) {
                console.error('Error loading files:', error);
                fileList.innerHTML = '<div class="empty-state"><p>Error loading files</p></div>';
            }
        }

        function renderFileList(filter = '') {
            const fileList = document.getElementById('fileList');
            const filtered = files.filter(f => {
                const matchesSearch = f.name.toLowerCase().includes(filter.toLowerCase());
                const matchesType = currentFilter === 'all' || f.type === currentFilter;
                return matchesSearch && matchesType;
            });

            if (filtered.length === 0) {
                fileList.innerHTML = '<div class="empty-state"><p>No files</p></div>';
                return;
            }

            fileList.innerHTML = filtered.map(f => {
                const isActive = currentFile && currentFile.key === f.key;
                const nameParts = f.name.split('.');
                const ext = nameParts.length > 1 ? '.' + nameParts.pop() : '';
                const name = nameParts.join('.');
                return `
                    <div class="file-item ${isActive ? 'active' : ''}" onclick="selectFile('${encodeURIComponent(f.key)}')">
                        <div class="file-icon ${f.type}">${getFileIcon(f.type)}</div>
                        <div class="file-info">
                            <div class="file-name"><span class="name-part">${name}</span><span class="ext-part">${ext}</span></div>
                            <div class="file-meta">${formatSize(f.size)} ¬∑ ${formatDate(f.lastModified)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterFiles() {
            const search = document.getElementById('searchInput').value;
            renderFileList(search);
        }

        async function selectFile(key) {
            const content = document.getElementById('viewerContent');
            const bucket = document.getElementById('bucketInput').value.trim();
            content.innerHTML = '<div class="empty-state"><div class="loading-spinner"></div></div>';

            try {
                const url = bucket ? `/api/file/${key}?bucket=${encodeURIComponent(bucket)}` : `/api/file/${key}`;
                const res = await fetch(url);
                const data = await res.json();

                if (data.error) {
                    content.innerHTML = `<div class="empty-state"><p>${data.error}</p></div>`;
                    return;
                }

                currentFile = data;
                renderFileList(document.getElementById('searchInput').value);
                renderViewer(data);
            } catch (error) {
                console.error('Error loading file:', error);
                content.innerHTML = '<div class="empty-state"><p>Error loading file</p></div>';
            }
        }

        function renderViewer(file) {
            imageTransform = { scale: 1, x: 0, y: 0 };
            isDragging = false;
            // Reset play button icon
            const playBtn = document.getElementById('playBtn');
            if (playBtn) playBtn.textContent = '‚ñ∂';

            const content = document.getElementById('viewerContent');

            switch (file.type) {
                case 'image':
                    renderImageViewer(file, content);
                    break;
                case 'video':
                    renderVideoViewer(file, content);
                    break;
                case 'audio':
                    renderAudioViewer(file, content);
                    break;
                case 'model3d':
                    const ext = file.name.split('.').pop().toLowerCase();
                    if (ext === 'ply') {
                        renderPLYViewer(file, content);
                    } else {
                        render3DViewer(file, content);
                    }
                    break;
                default:
                    renderDocumentViewer(file, content);
            }
        }

        // Image Viewer
        function renderImageViewer(file, content) {
            content.innerHTML = `
                <div class="image-container" id="imgContainer">
                    <div class="image-loading" id="imageLoading">
                        <div class="loading-spinner"></div>
                        <span>Loading image...</span>
                    </div>
                    <img src="${file.url}" alt="${file.name}" id="viewerImg" style="display:none">
                </div>
            `;

            const img = document.getElementById('viewerImg');
            img.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                imageTransform.scale = Math.max(0.1, Math.min(10, imageTransform.scale * delta));
                updateImageTransform();
            });
            img.addEventListener('mousedown', (e) => {
                e.preventDefault();
                isDragging = true;
                dragStart = { x: e.clientX, y: e.clientY };
            });

            img.onload = () => {
                const container = document.getElementById('imgContainer');
                const containerWidth = container.clientWidth;
                const containerHeight = container.clientHeight;
                const scaleX = containerWidth / img.naturalWidth;
                const scaleY = containerHeight / img.naturalHeight;
                imageTransform.scale = Math.min(scaleX, scaleY);
                updateImageTransform();
                document.getElementById('imageLoading').style.display = 'none';
                img.style.display = 'block';
            };
        }

        function updateImageTransform() {
            const img = document.getElementById('viewerImg');
            if (img) {
                img.style.transform = `translate(-50%, -50%) scale(${imageTransform.scale}) translate(${imageTransform.x}px, ${imageTransform.y}px)`;
            }
        }

        // Video Viewer
        function renderVideoViewer(file, content) {
            content.innerHTML = `
                <div class="video-wrapper">
                    <video id="mediaPlayer" src="${file.url}" preload="auto"></video>
                    <div class="video-controls">
                        <button class="play-btn" id="playBtn" onclick="toggleMediaPlay()">‚ñ∂</button>
                        <div class="progress-container">
                            <div class="progress-bar" onclick="seekMedia(event)">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <div class="time-info">
                                <span id="currentTime">0:00</span>
                                <span id="duration">0:00</span>
                            </div>
                        </div>
                        <div class="volume-group">
                            <span onclick="toggleMute()" style="cursor:pointer;font-size:12px">üîä</span>
                            <div class="volume-slider" onclick="setVolume(event)">
                                <div class="volume-level" id="volumeLevel"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            mediaEl = document.getElementById('mediaPlayer');
            mediaEl.addEventListener('loadedmetadata', () => {
                document.getElementById('duration').textContent = formatTime(mediaEl.duration);
            });
            mediaEl.addEventListener('timeupdate', updateProgress);
        }

        // Audio Viewer
        function renderAudioViewer(file, content) {
            content.innerHTML = `
                <div class="audio-wrapper">
                    <div class="audio-artwork">üéµ</div>
                    <div class="audio-details">
                        <div class="audio-title">${file.name}</div>
                        <div class="audio-artist">Unknown Artist</div>
                    </div>
                    <div class="audio-progress-container">
                        <div class="progress-bar" onclick="seekMedia(event)">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="audio-time">
                            <span id="currentTime">0:00</span>
                            <span id="duration">0:00</span>
                        </div>
                    </div>
                    <div class="audio-controls">
                        <button class="audio-btn" onclick="skipMedia(-10)">‚è™</button>
                        <button class="audio-btn play" id="playBtn" onclick="toggleMediaPlay()">‚ñ∂</button>
                        <button class="audio-btn" onclick="skipMedia(10)">‚è©</button>
                    </div>
                </div>
                <audio id="mediaPlayer" src="${file.url}" preload="auto" style="display:none"></audio>
            `;

            mediaEl = document.getElementById('mediaPlayer');
            mediaEl.addEventListener('loadedmetadata', () => {
                document.getElementById('duration').textContent = formatTime(mediaEl.duration);
            });
            mediaEl.addEventListener('timeupdate', updateProgress);
            mediaEl.addEventListener('error', (e) => {
                console.error('Audio error:', mediaEl.error);
            });
        }

        // 3D Model Viewer
        function render3DViewer(file, content) {
            content.innerHTML = `
                <div class="model-viewer-container">
                    <div class="model-loading" id="modelLoading">
                        <div class="model-loading-spinner"></div>
                        <span style="color: #888; font-size: 12px;">Loading 3D model...</span>
                    </div>
                    <model-viewer
                        src="${file.url}"
                        alt="${file.name}"
                        auto-rotate
                        camera-controls
                        shadow-intensity="1"
                        ar
                        ar-modes="webxr scene-viewer quick-look"
                        onload="document.getElementById('modelLoading').style.display='none'">
                    </model-viewer>
                </div>
            `;
        }

        // PLY Viewer using Three.js
        async function renderPLYViewer(file, content) {
            content.innerHTML = `
                <div class="ply-viewer-container" id="plyContainer">
                    <div class="model-loading" id="plyLoading">
                        <div class="model-loading-spinner"></div>
                        <span style="color: #888; font-size: 12px;">Loading PLY model...</span>
                    </div>
                    <canvas id="plyCanvas" class="ply-canvas"></canvas>
                    <div class="ply-viewer-controls" style="display:none" id="plyControls">
                        <button class="ply-btn" onclick="plyResetView()">Reset View</button>
                        <button class="ply-btn" onclick="plyToggleWireframe()">Wireframe</button>
                    </div>
                </div>
            `;

            try {
                const THREE = await import('three');
                const { OrbitControls } = await import('three/addons/controls/OrbitControls.js');
                const { PLYLoader } = await import('three/addons/loaders/PLYLoader.js');

                const container = document.getElementById('plyContainer');
                const canvas = document.getElementById('plyCanvas');

                // Scene setup
                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0x1a1a1a);

                // Camera
                const camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
                camera.position.set(0, 0, 3);

                // Renderer
                const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
                renderer.setSize(container.clientWidth, container.clientHeight);
                renderer.setPixelRatio(window.devicePixelRatio);

                // Controls
                const controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;

                // Lighting
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
                scene.add(ambientLight);

                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(1, 1, 1);
                scene.add(directionalLight);

                const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
                directionalLight2.position.set(-1, -1, -1);
                scene.add(directionalLight2);

                // Load PLY file
                const loader = new PLYLoader();
                loader.load(file.url, (geometry) => {
                    // Center and scale the model
                    geometry.computeBoundingBox();
                    const center = geometry.boundingBox.getCenter(new THREE.Vector3());
                    const size = geometry.boundingBox.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 2 / maxDim;
                    geometry.scale(scale, scale, scale);
                    geometry.translate(-center.x * scale, -center.y * scale, -center.z * scale);

                    // Create material - try vertex colors first, otherwise use gray
                    let material;
                    if (geometry.attributes.color) {
                        material = new THREE.MeshStandardMaterial({
                            vertexColors: true,
                            roughness: 0.5,
                            metalness: 0.1
                        });
                    } else {
                        material = new THREE.MeshStandardMaterial({
                            color: 0xaaaaaa,
                            roughness: 0.5,
                            metalness: 0.1
                        });
                    }

                    const mesh = new THREE.Mesh(geometry, material);
                    mesh.name = 'plyMesh';
                    scene.add(mesh);

                    // Hide loading, show controls
                    document.getElementById('plyLoading').style.display = 'none';
                    document.getElementById('plyControls').style.display = 'flex';

                    // Fit camera
                    camera.position.set(0, 0, 4);
                    controls.target.set(0, 0, 0);
                    controls.update();
                }, undefined, (error) => {
                    console.error('Error loading PLY:', error);
                    document.getElementById('plyLoading').innerHTML = '<span style="color: #888;">Error loading PLY file</span>';
                });

                // Store references for controls
                window.plyScene = scene;
                window.plyCamera = camera;
                window.plyRenderer = renderer;
                window.plyControls = controls;
                window.plyMaterial = null;

                // Animation loop
                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }
                animate();

                // Handle resize
                window.addEventListener('resize', () => {
                    const width = container.clientWidth;
                    const height = container.clientHeight;
                    camera.aspect = width / height;
                    camera.updateProjectionMatrix();
                    renderer.setSize(width, height);
                });

                // Expose control functions
                window.plyResetView = () => {
                    camera.position.set(0, 0, 4);
                    controls.target.set(0, 0, 0);
                    controls.update();
                };

                window.plyToggleWireframe = () => {
                    const mesh = scene.getObjectByName('plyMesh');
                    if (mesh && mesh.material) {
                        mesh.material.wireframe = !mesh.material.wireframe;
                    }
                };

            } catch (error) {
                console.error('Error initializing PLY viewer:', error);
                document.getElementById('plyLoading').innerHTML = '<span style="color: #888;">Error loading viewer</span>';
            }
        }

        // Document Viewer
        function renderDocumentViewer(file, content) {
            const ext = file.name.split('.').pop().toLowerCase();

            if (['txt', 'json', 'xml', 'html', 'htm', 'md'].includes(ext)) {
                content.innerHTML = `
                    <div class="empty-state">
                        <p>Preview not available</p>
                        <button class="btn btn-primary" onclick="window.open('${file.url}', '_blank')">Open</button>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="empty-state">
                        <p>${ext.toUpperCase()} - No preview</p>
                        <button class="btn btn-primary" onclick="downloadCurrent()">Download</button>
                    </div>
                `;
            }
        }

        // Media Controls
        function toggleMediaPlay() {
            if (!mediaEl) return;
            const btn = document.getElementById('playBtn');
            if (mediaEl.paused) {
                mediaEl.play();
                btn.textContent = '‚è∏';
            } else {
                mediaEl.pause();
                btn.textContent = '‚ñ∂';
            }
        }

        function updateProgress() {
            if (!mediaEl) return;
            const progress = (mediaEl.currentTime / mediaEl.duration) * 100;
            const fill = document.getElementById('progressFill');
            if (fill) fill.style.width = progress + '%';
            const time = document.getElementById('currentTime');
            if (time) time.textContent = formatTime(mediaEl.currentTime);
        }

        function seekMedia(e) {
            if (!mediaEl) return;
            const rect = e.target.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            mediaEl.currentTime = percent * mediaEl.duration;
        }

        function setVolume(e) {
            if (!mediaEl) return;
            const rect = e.target.getBoundingClientRect();
            const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
            mediaEl.volume = percent;
            const level = document.getElementById('volumeLevel');
            if (level) level.style.width = (percent * 100) + '%';
        }

        function toggleMute() {
            if (!mediaEl) return;
            mediaEl.muted = !mediaEl.muted;
        }

        function skipMedia(seconds) {
            if (!mediaEl) return;
            mediaEl.currentTime = Math.max(0, Math.min(mediaEl.duration, mediaEl.currentTime + seconds));
        }

        // Utilities
        function getFileIcon(type) {
            const icons = { image: 'üñºÔ∏è', video: 'üé¨', audio: 'üéµ', document: 'üìÑ', model3d: 'üßä', other: 'üìÅ' };
            return icons[type] || icons.other;
        }

        function formatSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) {
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else if (days === 1) {
                return 'Yesterday';
            } else if (days < 7) {
                return date.toLocaleDateString([], { weekday: 'short' });
            } else {
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            }
        }

        function formatTime(seconds) {
            if (!seconds || isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>
